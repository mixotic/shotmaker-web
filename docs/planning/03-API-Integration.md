# 03 - API Integration

> Complete reference for all external API calls, authentication, request/response formats, and error handling used by ShotMaker.

---

## Table of Contents

1. [API Key Management](#1-api-key-management)
2. [Google Gemini -- Image Generation](#2-google-gemini----image-generation)
3. [Google Veo -- Video Generation](#3-google-veo----video-generation)
4. [Google Files API](#4-google-files-api)
5. [Error Handling](#5-error-handling)
6. [ImageGenerationProvider Protocol](#6-imagegenerationprovider-protocol)
7. [VideoGenerationProvider Protocol](#7-videogenerationprovider-protocol)
8. [Model Capabilities Tables](#8-model-capabilities-tables)

---

## 1. API Key Management

### 1.1 KeychainService

**File:** `Services/KeychainService.swift`

All API keys are stored in the macOS Keychain using the Security framework. `KeychainService` is a singleton (`KeychainService.shared`) that provides three operations against `kSecClassGenericPassword` items.

#### Key Identifier Format

Each provider's API key is stored under a deterministic Keychain account name:

```
shotmaker.provider.<UUID>
```

Generated by `KeychainService.providerKeyIdentifier(for:)`:

```swift
static func providerKeyIdentifier(for providerId: UUID) -> String {
    return "shotmaker.provider.\(providerId.uuidString)"
}
```

#### Keychain Operations

| Operation | Method | Keychain Function | Accessibility |
|-----------|--------|-------------------|---------------|
| Save | `save(_:forKey:)` | `SecItemAdd` (deletes existing first via `SecItemDelete`) | `kSecAttrAccessibleWhenUnlocked` |
| Load | `load(forKey:)` | `SecItemCopyMatching` with `kSecMatchLimitOne` | -- |
| Delete | `delete(forKey:)` | `SecItemDelete` | -- |

**Save** -- Encodes the string value as UTF-8 `Data`, deletes any existing item with the same key, then adds the new item. Throws `KeychainError.unhandledError(status:)` on failure.

**Load** -- Returns `nil` if the item is not found (`errSecItemNotFound`). Returns the decoded UTF-8 string on success. Throws `KeychainError.unexpectedPasswordData` if the data cannot be decoded.

**Delete** -- Succeeds silently if the item does not exist (`errSecItemNotFound` is treated as success).

#### KeychainError Enum

```swift
enum KeychainError: Error {
    case saveFailed
    case loadFailed
    case deleteFailed
    case itemNotFound
    case unexpectedPasswordData
    case unhandledError(status: OSStatus)
}
```

### 1.2 AIProviderRegistry Lifecycle

**File:** `Services/AIProviderRegistry.swift`

`AIProviderRegistry` is a `@MainActor` singleton (`AIProviderRegistry.shared`) that manages the full lifecycle of AI providers. It is an `ObservableObject` so SwiftUI views react to provider changes.

#### Startup Sequence

1. `init()` calls `loadProviders()`
2. `loadProviders()` reads persisted provider metadata from `StorageService`
3. If no providers are found, a default Google provider is created with capabilities `[.imageGeneration, .videoGeneration]` and all six default model IDs
4. For each loaded provider, the registry attempts to load the API key from Keychain using `KeychainService.providerKeyIdentifier(for:)`
5. If the API key is found, `createProviderInstance(for:apiKey:)` instantiates the concrete provider classes (`GoogleGeminiProvider` for image, `GoogleVeoProvider` for video) and stores them in lookup dictionaries

#### Provider Registration

```swift
func registerProvider(_ provider: AIProvider, apiKey: String) throws
```

1. Saves the API key to Keychain
2. Appends the `AIProvider` to the `providers` array
3. Creates concrete provider instances
4. Persists provider metadata via `StorageService`

#### Provider Removal

```swift
func removeProvider(id: UUID) throws
```

1. Removes the `AIProvider` from the array
2. Removes cached image/video provider instances
3. Deletes the API key from Keychain
4. Persists updated provider list

#### Provider Update

```swift
func updateProvider(_ provider: AIProvider, apiKey: String?) throws
```

1. Replaces the provider in the array by matching `id`
2. If a new API key is provided, saves it to Keychain and recreates provider instances
3. Persists changes

#### Instance Lookup

| Method | Returns |
|--------|---------|
| `getImageProvider(id:)` | `(any ImageGenerationProvider)?` |
| `getVideoProvider(id:)` | `(any VideoGenerationProvider)?` |
| `getDefaultImageProvider()` | `(provider: AIProvider, instance: any ImageGenerationProvider)?` |
| `getDefaultVideoProvider()` | `(provider: AIProvider, instance: any VideoGenerationProvider)?` |
| `getProvider(id:)` | `AIProvider?` -- O(1) via `providersById` dictionary |

Default provider resolution: first checks `defaultForCapabilities`, then falls back to the first provider with the matching capability.

#### Default Provider Assignment

```swift
func setAsDefault(providerId: UUID, for capability: ProviderCapability) throws
```

Clears the capability from all other providers, then sets it on the target provider. Persists changes.

#### Usage Tracking

```swift
func incrementGenerationCount(providerId: UUID) throws
```

Increments `totalGenerations` and updates `lastUsed` timestamp on the provider. Persists changes.

---

## 2. Google Gemini -- Image Generation

**File:** `Services/ImageGeneration/GoogleGeminiProvider.swift`
**Configuration:** `Configuration/APIConfiguration.swift`

### 2.1 API Configuration

#### Base URLs

| Constant | URL | Usage |
|----------|-----|-------|
| `APIConfiguration.Gemini.baseURLStable` | `https://generativelanguage.googleapis.com/v1/models` | Defined but not currently used |
| `APIConfiguration.Gemini.baseURLBeta` | `https://generativelanguage.googleapis.com/v1beta/models` | All image generation requests |

The `baseURL(for:)` method always returns `baseURLBeta` because image generation requires `v1beta` for `responseModalities` and `imageConfig` support.

#### Model IDs

| Model ID | Display Name | Reference Count | API Version |
|----------|-------------|-----------------|-------------|
| `gemini-2.5-flash-image` | Gemini 2.5 Flash | Used as default model, availability check model | v1beta |
| `gemini-3-pro-image-preview` | Gemini 3 Pro Preview | Used for higher quality generation | v1beta |
| `gemini-2.5-flash` | Gemini 2.5 Flash (non-image) | Style analysis only (not image generation) | v1beta |

#### Timeout

All image generation requests use a **180-second (3-minute) timeout** (`requestTimeout = 180`).

### 2.2 Authentication

All requests use the `x-goog-api-key` HTTP header:

```
x-goog-api-key: <API_KEY>
```

No OAuth, no bearer tokens. The API key is passed directly in the header on every request.

### 2.3 Request Format

#### Endpoint URL Construction

```
https://generativelanguage.googleapis.com/v1beta/models/<MODEL_ID>:generateContent
```

Example:
```
https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent
```

#### HTTP Method and Headers

```
POST <endpoint>
x-goog-api-key: <API_KEY>
Content-Type: application/json
```

#### Request Body Structure (GeminiRequest)

```json
{
  "contents": [
    {
      "parts": [
        {
          "text": "<prompt_text>"
        },
        {
          "inline_data": {
            "mime_type": "image/png",
            "data": "<base64_encoded_image>"
          }
        }
      ]
    }
  ],
  "generationConfig": {
    "responseModalities": ["IMAGE"],
    "imageConfig": {
      "aspectRatio": "1:1",
      "imageSize": "2K"
    }
  }
}
```

**Key fields:**

| Field | Type | Description |
|-------|------|-------------|
| `contents` | `[Content]` | Array of content blocks. Single entry for simple generation; multiple entries for conversation-based refinement. |
| `contents[].parts` | `[Part]` | Array of parts within a content block. Can contain text parts and/or inline_data (image) parts. |
| `parts[].text` | `String?` | Text prompt. `null` when the part contains only image data. |
| `parts[].inline_data.mime_type` | `String` | Always `"image/png"` for reference images. |
| `parts[].inline_data.data` | `String` | Base64-encoded image data. |
| `generationConfig.responseModalities` | `[String]` | `["IMAGE"]` for image-only output; `["TEXT", "IMAGE"]` for batch generation. |
| `generationConfig.imageConfig.aspectRatio` | `String?` | Aspect ratio string (e.g., `"1:1"`, `"16:9"`, `"9:16"`, `"4:3"`, `"21:9"`, `"2.39:1"`). |
| `generationConfig.imageConfig.imageSize` | `String?` | Resolution tier. `nil` for flash models; `"2K"` default for pro models. Supported values: `"1K"`, `"2K"`, `"4K"`. |
| `generationConfig.num_images` | `Int?` | Optional. Not currently used (always `nil`). |

#### Aspect Ratio Handling

The aspect ratio `rawValue` from `ImageAspectRatio` is passed directly:

| Enum Case | rawValue Sent |
|-----------|---------------|
| `.square` | `"1:1"` |
| `.standard` | `"4:3"` |
| `.widescreen` | `"16:9"` |
| `.portrait` | `"9:16"` |
| `.ultrawide` | `"21:9"` |
| `.anamorphic` | `"2.39:1"` |

Default: `"1:1"` (square) when no aspect ratio is specified.

#### Resolution Handling

- For models containing `"pro"` in the name: defaults to `"2K"` if no resolution specified
- For flash models: `nil` (no imageSize sent)
- Supported values: `"1K"`, `"2K"`, `"4K"`

### 2.4 Response Format

```json
{
  "candidates": [
    {
      "content": {
        "parts": [
          {
            "text": "optional text response"
          },
          {
            "inline_data": {
              "mime_type": "image/png",
              "data": "<base64_encoded_image>"
            }
          }
        ]
      },
      "finish_reason": "STOP"
    }
  ]
}
```

**Response parsing notes:**

- The response decoder handles both `inline_data` (snake_case) and `inlineData` (camelCase) keys for the image data
- The response decoder handles both `mime_type` (snake_case) and `mimeType` (camelCase) keys
- If neither mime type key is found, defaults to `"image/png"`
- Base64 image data is cleaned of whitespace (`\n`, `\r`, spaces, tabs) before decoding
- A `finish_reason` of `"NO_IMAGE"` indicates the model could not generate an image (safety filters, complex prompt, etc.)

### 2.5 Operations

#### 2.5.1 generateImage -- Single Image Generation

Generates a single image from a text prompt with an optional reference image.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt` | `String` | Yes | Text description of desired image |
| `model` | `String` | Yes | Model ID (e.g., `"gemini-2.5-flash-image"`) |
| `referenceImage` | `Data?` | No | PNG image data for image-to-image generation |
| `aspectRatio` | `ImageAspectRatio?` | No | Desired aspect ratio (defaults to square) |
| `negativePrompt` | `String?` | No | Accepted but not used by Gemini API |
| `resolution` | `String?` | No | Resolution tier (`"1K"`, `"2K"`, `"4K"`) |

**Request construction:**

1. Creates a text part with the prompt
2. If `referenceImage` is provided, appends an `inline_data` part with base64-encoded PNG
3. Sets `responseModalities` to `["IMAGE"]`
4. Sends to `v1beta/models/<model>:generateContent`

**Returns:** `Data` -- PNG image data from the first candidate's first image part.

#### 2.5.2 generateImages -- Batch Image Generation

Generates multiple images in a single API call.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt` | `String` | Yes | Text description |
| `model` | `String` | Yes | Model ID |
| `candidateCount` | `Int` | Yes | Number of images to generate (1-4) |
| `referenceImage` | `Data?` | No | Optional reference image |
| `aspectRatio` | `ImageAspectRatio?` | No | Desired aspect ratio |
| `negativePrompt` | `String?` | No | Not used by Gemini |
| `resolution` | `String?` | No | Resolution tier |

**Batch prompt construction:**

When `candidateCount > 1`, the prompt is transformed into a numbered instruction format:

```
Call the image generation function with the following frequency. After each image generation, always check the number. You may finish when the last number is matched. Here are the images you must create:

[Prompt for image 1: <original_prompt>]
[Prompt for image 2: <original_prompt>]
[Prompt for image 3: <original_prompt>]
```

**Key difference from single generation:** `responseModalities` is set to `["TEXT", "IMAGE"]` (not just `["IMAGE"]`) to allow the model to interleave text responses between generated images.

**Backfill logic:** If the response contains fewer images than requested, additional single-image calls are made via `generateImage()` to fill the gap. If more images are returned than requested, the array is truncated.

#### 2.5.3 generateImageWithMultipleReferences -- Multi-Reference Composition

Generates a single image using multiple reference images for style/content guidance.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt` | `String` | Yes | Text description |
| `model` | `String` | Yes | Model ID |
| `referenceImages` | `[Data]` | Yes | Array of PNG image data |
| `aspectRatio` | `ImageAspectRatio?` | No | Desired aspect ratio |
| `negativePrompt` | `String?` | No | Not used by Gemini |
| `resolution` | `String?` | No | Resolution tier |

**Request construction:**

All reference images are appended as separate `inline_data` parts after the text prompt, all within a single `contents[]` entry:

```json
{
  "contents": [
    {
      "parts": [
        { "text": "<prompt>" },
        { "inline_data": { "mime_type": "image/png", "data": "<ref_1_base64>" } },
        { "inline_data": { "mime_type": "image/png", "data": "<ref_2_base64>" } },
        { "inline_data": { "mime_type": "image/png", "data": "<ref_3_base64>" } }
      ]
    }
  ],
  "generationConfig": {
    "responseModalities": ["IMAGE"],
    "imageConfig": { "aspectRatio": "1:1", "imageSize": "2K" }
  }
}
```

Model limits on reference images:
- `gemini-2.5-flash-image`: max 6 reference images
- `gemini-3-pro-image-preview`: max 14 reference images

#### 2.5.4 refineImageWithConversation -- Multi-Turn Refinement

Refines an image using conversation history context for iterative improvement.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `conversationHistory` | `ConversationHistory` | Yes | Full conversation with previous refinements |
| `newPrompt` | `String` | Yes | New refinement instruction |
| `currentImage` | `Data` | Yes | Current image to refine |
| `model` | `String` | Yes | Model ID |
| `aspectRatio` | `ImageAspectRatio?` | No | Desired aspect ratio |
| `negativePrompt` | `String?` | No | Not used |
| `resolution` | `String?` | No | Resolution tier |

**Request construction:**

This operation builds a multi-turn conversation in the `contents` array:

```json
{
  "contents": [
    {
      "parts": [{ "text": "original prompt" }]
    },
    {
      "parts": [{ "inline_data": { "mime_type": "image/png", "data": "<generated_image>" } }]
    },
    {
      "parts": [{ "text": "make the sky bluer" }, { "inline_data": { "mime_type": "image/png", "data": "<current_image>" } }]
    }
  ],
  "generationConfig": {
    "responseModalities": ["IMAGE"],
    "imageConfig": { "aspectRatio": "1:1" }
  }
}
```

**Conversation history handling:**

1. Calls `conversationHistory.getAPIContext()` which returns all non-system messages
2. Each historical message becomes a separate `contents[]` entry
3. Messages with text get a text part; messages with image data get an `inline_data` part
4. The new refinement prompt and current image are appended as the final `contents[]` entry
5. Conversation is bounded to 26 messages max (initial generation + ~12 refinement rounds)

#### 2.5.5 generateMultiView -- Multiple View Angles

Generates separate images for each requested view angle by calling `generateImage()` sequentially.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt` | `String` | Yes | Base subject description |
| `model` | `String` | Yes | Model ID |
| `views` | `[ViewAngle]` | Yes | Array of view angles to generate |
| `aspectRatio` | `ImageAspectRatio?` | No | Aspect ratio for each view |
| `negativePrompt` | `String?` | No | Not used |

**Prompt modification:** For each view, the prompt is modified to: `"<prompt>, <viewAngle.rawValue> view"`

**Returns:** `[Data]` -- Array of PNG images in the same order as the `views` parameter.

#### 2.5.6 generateReferenceSheet -- Character Turnaround Sheet

Generates a single composite image containing multiple views arranged as a reference sheet.

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `prompt` | `String` | Yes | Subject description |
| `model` | `String` | Yes | Model ID |
| `views` | `[ViewAngle]` | Yes | Views to include |
| `aspectRatio` | `ImageAspectRatio?` | No | Aspect ratio for the sheet |
| `negativePrompt` | `String?` | No | Not used |

**Prompt modification:** `"<prompt>, reference sheet with <view1>, <view2>, <view3> views, character turnaround sheet"`

**Returns:** `Data` -- Single PNG image containing all views.

#### 2.5.7 checkAvailability -- Provider Health Check

Sends a minimal `generateContent` request with prompt `"test"` and `responseModalities: ["IMAGE"]` to the `gemini-2.5-flash-image` model.

**Success criteria:**
- HTTP 200: returns `true`
- HTTP 400: returns `true` (the API key works; the request itself was intentionally minimal)
- HTTP 403 (non-quota): throws `authenticationFailed`
- HTTP 403 (quota): throws `quotaExceeded`
- HTTP 429: throws `rateLimitExceeded` or `quotaExceeded`
- HTTP 503: throws `serviceUnavailable`

### 2.6 Complete Gemini Request/Response Codable Models

#### Request Models (private)

```swift
struct GeminiRequest: Codable {
    let contents: [Content]
    let generationConfig: GenerationConfig

    struct Content: Codable {
        let parts: [Part]

        struct Part: Codable {
            let text: String?               // JSON key: "text"
            let inlineData: InlineData?     // JSON key: "inline_data"

            struct InlineData: Codable {
                let mimeType: String        // JSON key: "mime_type"
                let data: String            // JSON key: "data"
            }
        }
    }

    struct GenerationConfig: Codable {
        let responseModalities: [String]    // JSON key: "responseModalities"
        let imageConfig: ImageConfig?       // JSON key: "imageConfig"
        let numImages: Int?                 // JSON key: "num_images"
    }

    struct ImageConfig: Codable {
        let aspectRatio: String?            // JSON key: "aspectRatio"
        let imageSize: String?              // JSON key: "imageSize"
    }
}
```

**Note:** `GenerationConfig` and `ImageConfig` use custom `encode(to:)` implementations that skip `nil` values entirely (fields are omitted from JSON, not sent as `null`).

#### Response Models (private)

```swift
struct GeminiResponse: Decodable {
    let candidates: [Candidate]

    struct Candidate: Decodable {
        let content: Content?
        let finishReason: String?           // JSON key: "finish_reason"

        struct Content: Decodable {
            let parts: [Part]

            struct Part: Decodable {
                let text: String?
                let inlineData: InlineData?
                // Decodes from either "inline_data" or "inlineData"

                struct InlineData: Decodable {
                    let mimeType: String
                    // Decodes from either "mime_type" or "mimeType"
                    // Defaults to "image/png" if neither found
                    let data: String
                }
            }
        }
    }
}
```

---

## 3. Google Veo -- Video Generation

**File:** `Services/VideoGeneration/GoogleVeoProvider.swift`
**Configuration:** `Configuration/APIConfiguration.swift`

### 3.1 API Configuration

#### Base URL

```
https://generativelanguage.googleapis.com/v1beta
```

Defined as `APIConfiguration.Veo.baseURL`.

#### Model IDs

| Model ID | Display Name | Frame Mode | Last Frame | Reference Images | Extension |
|----------|-------------|------------|------------|------------------|-----------|
| `veo-3.1-generate-preview` | Veo 3.1 Standard | referenceOrInterpolation | Yes | Yes (up to 3) | Yes |
| `veo-3.1-fast-generate-preview` | Veo 3.1 Fast | interpolation | Yes | No | Yes |
| `veo-3.0-generate-001` | Veo 3.0 Standard | interpolation | No | No | Yes |
| `veo-3.0-fast-generate-001` | Veo 3.0 Fast | interpolation | No | No | Yes |

#### Timeouts and Polling

| Constant | Value | Description |
|----------|-------|-------------|
| `operationTimeout` | 600 seconds (10 minutes) | Maximum wait time for video generation |
| `pollingInterval` | 3.0 seconds | Time between status poll requests |
| `initialPollDelay` | 5.0 seconds | Delay before first poll after starting operation |

### 3.2 Authentication

Same as Gemini -- API key in the `x-goog-api-key` header:

```
x-goog-api-key: <API_KEY>
```

Video download uses a query parameter instead:
```
GET <video_uri>?key=<API_KEY>
```

### 3.3 Video Generation -- predictLongRunning

#### Step 1: Start Long-Running Operation

**URL Construction:**

```
POST https://generativelanguage.googleapis.com/v1beta/models/<MODEL_ID>:predictLongRunning
```

Example:
```
POST https://generativelanguage.googleapis.com/v1beta/models/veo-3.1-generate-preview:predictLongRunning
```

**HTTP Method and Headers:**

```
POST <endpoint>
x-goog-api-key: <API_KEY>
Content-Type: application/json
```

**Request Body Structure:**

```json
{
  "instances": [
    {
      "prompt": "<text_description>",
      "image": {
        "mimeType": "image/jpeg",
        "bytesBase64Encoded": "<base64_first_frame>"
      },
      "lastFrame": {
        "mimeType": "image/jpeg",
        "bytesBase64Encoded": "<base64_last_frame>"
      },
      "referenceImages": [
        {
          "referenceType": "asset",
          "image": {
            "bytesBase64Encoded": "<base64_ref_image>",
            "mimeType": "image/jpeg"
          }
        }
      ]
    }
  ],
  "parameters": {
    "aspectRatio": "16:9",
    "resolution": "720p",
    "durationSeconds": 8,
    "sampleCount": 1
  }
}
```

**Instance fields (varies by image mode):**

| Field | Type | Condition | Description |
|-------|------|-----------|-------------|
| `prompt` | `String` | Always | Text description of the video |
| `image` | `Object` | `imageMode == .interpolation` and first frame provided | First frame image with `mimeType` and `bytesBase64Encoded` |
| `lastFrame` | `Object` | `imageMode == .interpolation` and second image provided | Last frame image (same format as `image`) |
| `referenceImages` | `[Object]` | `imageMode == .reference` | Array of reference images (max 3), each with `referenceType: "asset"` and nested `image` object |
| `video` | `Object` | Video extension only | Contains `uri` field with previous video's URI |

**Parameters fields:**

| Field | Type | Values | Description |
|-------|------|--------|-------------|
| `aspectRatio` | `String` | `"16:9"`, `"9:16"` | Video aspect ratio. Forced to `"16:9"` for reference image mode. |
| `resolution` | `String` | `"720p"`, `"1080p"` | Video resolution |
| `durationSeconds` | `Int` | `4`, `6`, `8` | Video duration. Must be `8` when images are provided. |
| `sampleCount` | `Int` | `1` | Always 1. Number of video samples to generate. |

**Note:** `negativePrompt` is NOT sent as an API parameter. All exclusions are merged into the prompt string before the API call.

**Response (operation started):**

```json
{
  "name": "operations/generate-video-abc123xyz"
}
```

The `name` field is the operation identifier used for polling.

#### Step 2: Poll for Completion

**URL Construction:**

```
GET https://generativelanguage.googleapis.com/v1beta/<operationName>
```

Example:
```
GET https://generativelanguage.googleapis.com/v1beta/operations/generate-video-abc123xyz
```

**HTTP Method and Headers:**

```
GET <endpoint>
x-goog-api-key: <API_KEY>
```

No request body.

**Polling algorithm:**

1. Wait `initialPollDelay` (5 seconds) before first poll
2. Send GET request to the operation URL
3. If response contains `"done": true`:
   - Check for `error` field -- if present, throw with the error message
   - Otherwise, parse video URI from the response
4. If not done, wait `pollingInterval` (3 seconds) and repeat
5. If `operationTimeout` (600 seconds) is exceeded, throw timeout error

**Polling response (in progress):**

```json
{
  "name": "operations/generate-video-abc123xyz",
  "done": false
}
```

**Polling response (completed):**

```json
{
  "name": "operations/generate-video-abc123xyz",
  "done": true,
  "response": {
    "generateVideoResponse": {
      "generatedSamples": [
        {
          "video": {
            "uri": "https://generativelanguage.googleapis.com/v1beta/files/abc123?alt=media"
          }
        }
      ]
    }
  }
}
```

**Polling response (failed):**

```json
{
  "name": "operations/generate-video-abc123xyz",
  "done": true,
  "error": {
    "message": "Video generation failed: safety filter triggered"
  }
}
```

**Response parsing path:** `response.generateVideoResponse.generatedSamples[0].video.uri`

The `videoUri` is also used as the `videoReference` for video extension chaining.

#### Step 3: Download Video

**URL Construction:**

```
GET <videoUri>?key=<API_KEY>
```

If the URI already contains a query string:
```
GET <videoUri>&key=<API_KEY>
```

**HTTP Method:** `GET`

**No special headers.** Authentication is via the `key` query parameter.

**Response:** Raw video binary data (`Data`). Throws if the response is empty or the HTTP status is not 200.

### 3.4 Image Modes

The `ImageMode` enum determines how images are incorporated into video generation:

#### `.none` -- Text-to-Video

No images are sent in the instance. Only the `prompt` field is populated.

```json
{
  "instances": [
    {
      "prompt": "A cat walking through a garden"
    }
  ],
  "parameters": { ... }
}
```

#### `.interpolation` -- First/Last Frame

Uses provided images as first frame and optionally last frame. The model generates video that transitions between these frames.

```json
{
  "instances": [
    {
      "prompt": "A cat walking through a garden",
      "image": {
        "mimeType": "image/jpeg",
        "bytesBase64Encoded": "<base64_first_frame>"
      },
      "lastFrame": {
        "mimeType": "image/jpeg",
        "bytesBase64Encoded": "<base64_last_frame>"
      }
    }
  ],
  "parameters": { ... }
}
```

- First frame: `imageItems[0].previewImageData` mapped to `instance["image"]`
- Last frame: `imageItems[1].previewImageData` mapped to `instance["lastFrame"]` (only if 2+ images provided)
- `lastFrame` is a direct object, not nested inside an `image` wrapper

**Model support:**
- All four Veo models support first frame
- Only Veo 3.1 models (Standard and Fast) support last frame

#### `.reference` -- Style Reference Images (Veo 3.1 Standard Only)

Uses images as style/content references (not frame interpolation). Up to 3 reference images.

```json
{
  "instances": [
    {
      "prompt": "A cat walking through a garden",
      "referenceImages": [
        {
          "referenceType": "asset",
          "image": {
            "bytesBase64Encoded": "<base64_ref_1>",
            "mimeType": "image/jpeg"
          }
        },
        {
          "referenceType": "asset",
          "image": {
            "bytesBase64Encoded": "<base64_ref_2>",
            "mimeType": "image/jpeg"
          }
        }
      ]
    }
  ],
  "parameters": {
    "aspectRatio": "16:9",
    ...
  }
}
```

**Constraints:**
- Maximum 3 reference images (`.prefix(3)`)
- `referenceType` must be `"asset"` (lowercase)
- Aspect ratio is forced to `"16:9"` regardless of user selection
- Only supported by `veo-3.1-generate-preview` (`.referenceOrInterpolation` mode)

### 3.5 Video Extension

**Method:** `extendVideo(videoReference:prompt:model:extensionDuration:aspectRatio:resolution:negativePrompt:)`

Extends an existing video by appending new generated content to the end.

**Important constraints:**
- Always uses `veo-3.1-generate-preview` regardless of which model was passed (only model supporting extensions)
- Extension duration is fixed at 7 seconds by the API; the `extensionDuration` parameter is not sent to the API
- Requires a valid `videoReference` (the download URI from the original generation)
- `negativePrompt` is merged into the prompt, not sent as a parameter

**Request body:**

```json
{
  "instances": [
    {
      "prompt": "<extension_description>",
      "video": {
        "uri": "<videoReference_URI>"
      }
    }
  ],
  "parameters": {
    "aspectRatio": "16:9",
    "resolution": "720p",
    "sampleCount": 1
  }
}
```

Note: `durationSeconds` is NOT included in the parameters for extensions.

**URI chaining:** Each extension returns a new `videoReference` (the URI of the extended video), which can be used for subsequent extensions, enabling chained multi-segment video creation.

**Returns:** `(data: Data, reference: String?)` -- The video binary data and the new video reference URI.

### 3.6 Duration Rules

| Scenario | Allowed Durations | Notes |
|----------|-------------------|-------|
| Text-to-video (no images) | 4s, 6s, 8s | All Veo models |
| With first frame image | 8s required | API constraint when images provided |
| With first + last frame | 8s required | Veo 3.1 models only |
| With reference images | 8s required | Veo 3.1 Standard only |
| Video extension | 7s fixed | Not configurable |

### 3.7 Cost and Time Estimation

```swift
func estimateGenerationTime(duration: TimeInterval) -> TimeInterval {
    return max(11, duration * 30)
}
```

| Duration | Estimated Time |
|----------|---------------|
| 4s | 120s (2 min) |
| 6s | 180s (3 min) |
| 8s | 240s (4 min) |

```swift
func estimateCost(duration: TimeInterval, resolution: String) -> Double {
    let costPerSecond = isFastModel ? 0.15 : 0.40
    return duration * costPerSecond
}
```

| Model Type | Cost/Second | 4s | 6s | 8s |
|------------|-------------|----|----|-----|
| Standard | $0.40 | $1.60 | $2.40 | $3.20 |
| Fast | $0.15 | $0.60 | $0.90 | $1.20 |

### 3.8 Protocol Conformance Wrapper

The `VideoGenerationProvider` protocol requires a `frames: [Frame]` signature. The `GoogleVeoProvider` wraps this by converting frames to `ImageSelectionItem` objects and delegating to the `imageItems`-based implementation with `.interpolation` mode:

```swift
func generateVideo(frames: [Frame], ...) async throws -> (data: Data, reference: String?) {
    let imageItems = frames.map { ImageSelectionItem.frame($0) }
    return try await generateVideo(imageItems: imageItems, ..., imageMode: .interpolation)
}
```

---

## 4. Google Files API

**File:** `Services/GoogleFilesService.swift`

`GoogleFilesService` is a singleton (`GoogleFilesService.shared`) that manages file uploads, retrieval, validation, and deletion via the Google Files API. It uses a resumable upload protocol.

**Base URL:** `https://generativelanguage.googleapis.com`

### 4.1 uploadImage -- Resumable File Upload

Uploads image data to the Google Files API in two steps and returns a file URI.

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `data` | `Data` | -- | Image binary data |
| `apiKey` | `String` | -- | Google API key |
| `filename` | `String` | `"image.jpg"` | Display name for the file |
| `mimeType` | `String` | `"image/jpeg"` | MIME type of the file |

#### Step 1: Initiate Resumable Upload

**URL:**

```
POST https://generativelanguage.googleapis.com/upload/v1beta/files?uploadType=resumable
```

**Headers:**

```
x-goog-api-key: <API_KEY>
Content-Type: application/json
X-Goog-Upload-Protocol: resumable
X-Goog-Upload-Command: start
X-Goog-Upload-Header-Content-Type: <mimeType>
X-Goog-Upload-Header-Content-Length: <fileSize_in_bytes>
```

**Request Body:**

```json
{
  "file": {
    "display_name": "<filename>"
  }
}
```

**Response:** HTTP 200 with the upload URL in the `X-Goog-Upload-URL` response header. This URL is used in Step 2.

#### Step 2: Upload File Content

**URL:** The URL returned in `X-Goog-Upload-URL` from Step 1.

**HTTP Method:** `POST`

**Headers:**

```
X-Goog-Upload-Command: upload, finalize
X-Goog-Upload-Offset: 0
Content-Type: <mimeType>
```

**Request Body:** Raw binary image data.

**Response:**

```json
{
  "file": {
    "name": "files/abc123def456",
    "displayName": "image.jpg",
    "mimeType": "image/jpeg",
    "sizeBytes": "123456",
    "uri": "https://generativelanguage.googleapis.com/v1beta/files/abc123def456",
    "state": "ACTIVE",
    "expirationTime": "2025-01-22T10:30:00Z"
  }
}
```

**Return value:** The `uri` field from the response, used as the file URI in subsequent API requests.

### 4.2 getFileInfo -- Retrieve File Metadata

**URL:**

```
GET https://generativelanguage.googleapis.com/v1beta/files/<fileId>
```

**Headers:**

```
x-goog-api-key: <API_KEY>
```

**Response:** Same `FileInfoResponse` structure as the upload response (without the wrapper).

**Parsed into `FileInfo`:**

```swift
struct FileInfo {
    let id: String          // Extracted from "files/abc123" -> "abc123"
    let name: String        // displayName
    let mimeType: String
    let sizeBytes: Int      // Converted from String
    let uri: String
    let expirationTime: Date?  // ISO 8601
}
```

### 4.3 deleteFile -- Remove File

**URL:**

```
DELETE https://generativelanguage.googleapis.com/v1beta/files/<fileId>
```

**Headers:**

```
x-goog-api-key: <API_KEY>
```

**Success:** HTTP 200 or 204.

### 4.4 isFileValid -- Check File Expiry

```swift
func isFileValid(fileId: String, apiKey: String) async -> Bool
```

Calls `getFileInfo()` and returns `true` if the call succeeds, `false` on any error (including file not found or expired).

### 4.5 GoogleFilesError Enum

```swift
enum GoogleFilesError: LocalizedError {
    case invalidURL          // "Invalid URL for Files API"
    case uploadFailed(String)    // "Failed to upload file: <message>"
    case operationFailed(String) // "Files API operation failed: <message>"
    case invalidResponse     // "Invalid response from Files API"
}
```

---

## 5. Error Handling

### 5.1 APIError Enum

**File:** `Services/ImageGeneration/ImageGenerationProtocol.swift`

```swift
enum APIError: Error {
    case invalidURL
    case requestFailed
    case invalidResponse
    case authenticationFailed
    case rateLimitExceeded
    case quotaExceeded
    case serviceUnavailable
    case decodingFailed
    case networkError(Error)
    case unknownError(String)
}
```

#### User-Facing Error Messages

| Case | `errorDescription` |
|------|-------------------|
| `invalidURL` | "Invalid URL: Failed to construct the API endpoint URL" |
| `requestFailed` | "Request Failed: The API request could not be completed" |
| `invalidResponse` | "Invalid Response: The API returned an unexpected response format" |
| `authenticationFailed` | "Authentication Failed: Please check your API key is correct" |
| `rateLimitExceeded` | "Rate Limit Exceeded: Too many requests. Please try again later. Note: If you're using the Google Gemini free tier, make sure you have billing linked to your Google Cloud account. You will not be charged, but this is required to use Gemini with ShotMaker." |
| `quotaExceeded` | "API Quota Exceeded: You have reached your daily or monthly usage limit for this API. Quotas typically reset at midnight Pacific Time. Consider upgrading your API plan for higher limits." |
| `serviceUnavailable` | "Service Unavailable: The API service is temporarily unavailable" |
| `decodingFailed` | "Decoding Failed: Could not parse the API response" |
| `networkError(error)` | "Network Error: \(error.localizedDescription)" |
| `unknownError(message)` | "Unknown Error: \(message)" |

### 5.2 HTTP Status Code Mapping

Both `GoogleGeminiProvider` and `GoogleVeoProvider` use the same mapping logic:

| HTTP Status | Default APIError | Quota Override (body contains quota/daily/limit keywords) |
|-------------|-----------------|-----------------------------------------------------------|
| 400 | `unknownError("Bad Request (400): <body>")` | -- |
| 401 | `authenticationFailed` | -- |
| 403 | `authenticationFailed` | `quotaExceeded` if body contains "quota", "resource_exhausted", "daily", or "limit" |
| 404 | `unknownError("Not Found (404): Check model name is correct")` | -- |
| 429 | `rateLimitExceeded` | `quotaExceeded` if body contains "quota", "daily", or "monthly" |
| 500, 502 | `serviceUnavailable` (Veo polling only) | -- |
| 503 | `serviceUnavailable` | -- |
| Other | `unknownError("HTTP <code>: <body>")` | -- |

### 5.3 Quota vs. Rate Limit Detection

The error handler distinguishes between temporary rate limiting and quota exhaustion by inspecting the response body (case-insensitive):

**Quota indicators** (throw `quotaExceeded`):
- `"quota"`
- `"resource_exhausted"`
- `"daily"`
- `"limit"` (for 403 only)
- `"monthly"` (for 429 only)

**Rate limit** (throw `rateLimitExceeded`):
- HTTP 429 without any quota keywords

This distinction matters for user guidance: quota resets require waiting (midnight PT) or upgrading, while rate limits resolve by simply waiting a few minutes.

### 5.4 Additional Error Conditions

| Condition | Error Thrown |
|-----------|-------------|
| No candidates in Gemini response | `invalidResponse` |
| `finishReason == "NO_IMAGE"` | `unknownError` with guidance about safety filters |
| No image parts in candidate content | `invalidResponse` |
| Base64 decoding failure | `decodingFailed` |
| Missing operation name in Veo response | `unknownError("Missing operation name in response")` |
| Video generation timeout (>600s) | `unknownError("Video generation timed out after 600 seconds")` |
| Operation error in Veo response | `unknownError("Video generation failed: <message>")` |
| No video URI in response | `unknownError("No video URI in response")` |
| Empty downloaded video | `unknownError("Downloaded video is empty")` |
| Empty video reference for extension | `unknownError("No video reference available. Generate a video first...")` |

### 5.5 ValidationError -- User-Facing Error Transformation

**File:** `Models/ValidationError.swift`

The `ValidationError.fromAPIError(_:provider:model:)` static method transforms raw API errors into structured user-friendly messages with actionable solutions and error codes for debugging:

| Pattern in Error String | Error Code | Solution |
|------------------------|------------|----------|
| `authenticationFailed`, `403`, `401` | `AUTH_001` | Re-enter or refresh credentials |
| `quotaExceeded`, `Quota Exceeded` | `QUOTA_001` | Wait for quota reset (midnight PT) or upgrade plan |
| `rateLimitExceeded`, `429` | `RATE_001` | Wait a few minutes |
| `serviceUnavailable`, `503`, `500` | `SVC_001` | Try again later or use different provider |
| `networkError`, `offline` | `NET_001` | Check internet connection |
| `timeout`, `timed out` | `NET_002` | Retry; may indicate high server load |
| `invalidResponse`, `decodingFailed` | `RESP_001` | Temporary issue, try again |
| `model is not supported` | -- | Select different model or adjust settings |
| `Camera control is not supported` | -- | Select "None" for camera movement |
| Other | `HTTP_<code>` | Generic fallback with actual error |

---

## 6. ImageGenerationProvider Protocol

**File:** `Services/ImageGeneration/ImageGenerationProtocol.swift`

### 6.1 Protocol Properties

| Property | Type | Description |
|----------|------|-------------|
| `providerId` | `UUID` | Unique identifier for this provider instance |
| `capabilities` | `[ProviderCapability]` | Supported capabilities (e.g., `.imageGeneration`, `.imageToImage`) |
| `availableModels` | `[String]` | List of model IDs this provider supports |

### 6.2 Required Methods

#### `getModelCapabilities(for:) -> ImageModelCapabilities?`

Returns the capability descriptor for a given model ID, or `nil` if the model is unknown.

#### `generateImage(prompt:model:referenceImage:aspectRatio:negativePrompt:resolution:) async throws -> Data`

Generate a single image. Returns PNG image data.

#### `checkAvailability() async throws -> Bool`

Test whether the provider is properly configured and reachable.

### 6.3 Methods with Default Implementations

These methods have default implementations in the protocol extension but can be overridden by conforming types (as `GoogleGeminiProvider` does for all of them):

| Method | Default Behavior | GoogleGeminiProvider Override |
|--------|-----------------|------------------------------|
| `generateImages(...)` | Calls `generateImage()` N times sequentially | Uses batch prompt with `["TEXT", "IMAGE"]` modalities |
| `generateImageWithMultipleReferences(...)` | Uses only the first reference image | Sends all references as separate `inline_data` parts |
| `refineImageWithConversation(...)` | Falls back to standard image-to-image | Builds multi-turn conversation in `contents[]` |
| `generateMultiView(...)` | Generates each view sequentially | Generates each view sequentially with `"<prompt>, <view> view"` |
| `generateReferenceSheet(...)` | Passes prompt directly to `generateImage()` | Appends `", reference sheet with <views> views, character turnaround sheet"` |

### 6.4 Full Method Signatures

```swift
func generateImages(
    prompt: String,
    model: String,
    candidateCount: Int,          // 1-4
    referenceImage: Data?,
    aspectRatio: ImageAspectRatio?,
    negativePrompt: String?,
    resolution: String?
) async throws -> [Data]

func generateImageWithMultipleReferences(
    prompt: String,
    model: String,
    referenceImages: [Data],
    aspectRatio: ImageAspectRatio?,
    negativePrompt: String?,
    resolution: String?
) async throws -> Data

func refineImageWithConversation(
    conversationHistory: ConversationHistory,
    newPrompt: String,
    currentImage: Data,
    model: String,
    aspectRatio: ImageAspectRatio?,
    negativePrompt: String?,
    resolution: String?
) async throws -> Data

func generateMultiView(
    prompt: String,
    model: String,
    views: [ViewAngle],
    aspectRatio: ImageAspectRatio?,
    negativePrompt: String?
) async throws -> [Data]

func generateReferenceSheet(
    prompt: String,
    model: String,
    views: [ViewAngle],
    aspectRatio: ImageAspectRatio?,
    negativePrompt: String?
) async throws -> Data
```

---

## 7. VideoGenerationProvider Protocol

**File:** `Services/VideoGeneration/VideoGenerationProtocol.swift`

### 7.1 Protocol Properties

| Property | Type | Description |
|----------|------|-------------|
| `providerId` | `UUID` | Unique identifier for this provider instance |
| `capabilities` | `[ProviderCapability]` | Always `[.videoGeneration]` for Veo |
| `availableModels` | `[String]` | List of model IDs |

### 7.2 Required Methods

#### `getModelCapabilities(for:) -> ModelCapabilities?`

Returns the capability descriptor for a given model ID.

#### `generateVideo(frames:prompt:model:duration:aspectRatio:resolution:negativePrompt:cameraMovement:) async throws -> (data: Data, reference: String?)`

Generate a video from frames and a prompt. Returns the video binary data and an optional reference string for extensions.

### 7.3 Methods with Default Implementations

| Method | Default Behavior |
|--------|-----------------|
| `checkAvailability()` | Returns `true` |
| `estimateGenerationTime(duration:)` | `duration * 20.0` seconds |
| `estimateCost(duration:resolution:)` | `duration * 0.30 * (resolution == "1080p" ? 1.2 : 1.0)` |
| `extendVideo(...)` | Throws `"Video extension not supported by this provider"` |

### 7.4 Full Method Signatures

```swift
func generateVideo(
    frames: [Frame],
    prompt: String,
    model: String,
    duration: TimeInterval,
    aspectRatio: String,            // "16:9" or "9:16"
    resolution: String,             // "720p" or "1080p"
    negativePrompt: String?,
    cameraMovement: String?
) async throws -> (data: Data, reference: String?)

func checkAvailability() async throws -> Bool

func estimateGenerationTime(duration: TimeInterval) -> TimeInterval

func estimateCost(duration: TimeInterval, resolution: String) -> Double

func extendVideo(
    videoReference: String,
    prompt: String,
    model: String,
    extensionDuration: TimeInterval,
    aspectRatio: String,
    resolution: String,
    negativePrompt: String?
) async throws -> (data: Data, reference: String?)
```

### 7.5 ModelCapabilities Struct

```swift
struct ModelCapabilities {
    let modelId: String
    let displayName: String
    let description: String
    let frameSelectionMode: FrameSelectionMode
    let maxFrames: Int
    let supportsFirstFrame: Bool
    let supportsLastFrame: Bool
    let requiredDuration: TimeInterval?
    let maxDuration: TimeInterval
    let minDuration: TimeInterval
    let supportedAspectRatios: [String]
    let supportedResolutions: [String]
    let availableDurations: [Int]?
    let supportsNegativePrompt: Bool
    let supportsCameraMovement: Bool
    let supportsVideoExtension: Bool
    let aspectRatioFormat: AspectRatioFormat

    // Computed
    var supportsReferenceImages: Bool  // true only for .referenceOrInterpolation
}
```

**FrameSelectionMode:**

```swift
enum FrameSelectionMode {
    case reference                  // Style reference images only
    case interpolation              // First/last frame interpolation only
    case referenceOrInterpolation   // Supports both modes
}
```

**AspectRatioFormat:**

```swift
enum AspectRatioFormat {
    case ratio(String)       // e.g., "16:9" with field name
    case dimensions(String)  // e.g., "1920x1080" with field name
    case promptBased         // Injected into prompt text
    case none                // Not supported
}
```

---

## 8. Model Capabilities Tables

### 8.1 Image Generation Models

**File:** `Models/ImageModelCapabilities.swift`, `Services/ImageGeneration/GoogleGeminiProvider.swift`

| Capability | gemini-2.5-flash-image | gemini-3-pro-image-preview |
|-----------|----------------------|---------------------------|
| **Display Name** | Gemini 2.5 Flash | Gemini 3 Pro Preview |
| **Text-to-Image** | Yes | Yes |
| **Image-to-Image** | Yes | Yes |
| **Multi-Image Composition** | Yes | Yes |
| **Max Reference Images** | 6 | 14 |
| **Min Reference Images** | 0 | 0 |
| **Negative Prompt** | No | No |
| **Supported Aspect Ratios** | 1:1, 4:3, 16:9, 9:16, 21:9 | 1:1, 4:3, 16:9, 9:16, 21:9 |
| **Aspect Ratio Format** | ratio ("aspectRatio") | ratio ("aspectRatio") |
| **Supported Resolutions** | (none -- single tier) | 1K, 2K, 4K |
| **Default Resolution** | nil | 2K |
| **Max Candidate Count** | 4 | 4 |
| **API Version** | v1beta | v1beta |
| **Timeout** | 180s | 180s |

### 8.2 Video Generation Models

**File:** `Services/VideoGeneration/GoogleVeoProvider.swift`

| Capability | veo-3.1-generate-preview | veo-3.1-fast-generate-preview | veo-3.0-generate-001 | veo-3.0-fast-generate-001 |
|-----------|-------------------------|-------------------------------|---------------------|--------------------------|
| **Display Name** | Veo 3.1 Standard | Veo 3.1 Fast | Veo 3.0 Standard | Veo 3.0 Fast |
| **Frame Selection Mode** | referenceOrInterpolation | interpolation | interpolation | interpolation |
| **Max Frames** | 3 | 2 | 1 | 1 |
| **First Frame** | Yes | Yes | Yes | Yes |
| **Last Frame** | Yes | Yes | No | No |
| **Reference Images** | Yes (up to 3) | No | No | No |
| **Required Duration** | nil (flexible) | nil (flexible) | nil (flexible) | nil (flexible) |
| **Min Duration** | 4s | 4s | 4s | 4s |
| **Max Duration** | 8s | 8s | 8s | 8s |
| **Available Durations** | 4, 6, 8 | 4, 6, 8 | 4, 6, 8 | 4, 6, 8 |
| **Aspect Ratios** | 16:9, 9:16 | 16:9, 9:16 | 16:9, 9:16 | 16:9, 9:16 |
| **Resolutions** | 720p, 1080p | 720p, 1080p | 720p, 1080p | 720p, 1080p |
| **Negative Prompt** | Yes (via prompt merge) | Yes (via prompt merge) | Yes (via prompt merge) | Yes (via prompt merge) |
| **Camera Movement** | No | No | No | No |
| **Video Extension** | Yes | Yes | Yes | Yes |
| **Aspect Ratio Format** | ratio ("aspect_ratio") | ratio ("aspect_ratio") | ratio ("aspect_ratio") | ratio ("aspect_ratio") |
| **Est. Cost/Second** | $0.40 | $0.15 | $0.40 | $0.15 |
| **Polling Timeout** | 600s | 600s | 600s | 600s |

### 8.3 Provider Capabilities

**File:** `Models/AIProvider.swift`

| Provider Type | Capabilities | Default Models |
|--------------|-------------|----------------|
| Google | imageGeneration, videoGeneration | gemini-2.5-flash-image, gemini-3-pro-image-preview, veo-3.1-generate-preview, veo-3.1-fast-generate-preview, veo-3.0-generate-001, veo-3.0-fast-generate-001 |

**ProviderCapability Enum:**

```swift
enum ProviderCapability: String, Codable, CaseIterable {
    case imageGeneration = "Image Generation"
    case imageToImage = "Image-to-Image"
    case videoGeneration = "Video Generation"
    case multiView = "Multi-View Generation"
}
```

**Model filtering:** `AIProvider.getModelsForCapability(_:)` filters the `modelOptions` array by string patterns:
- Image capabilities: excludes models containing "veo", "gen-3", "gen-2", "runway"
- Video capability: includes models containing "veo", "gen-3", "gen-2", "runway", or "video"

### 8.4 ImageAspectRatio Enum

**File:** `Models/AspectRatio.swift`

| Case | rawValue | Numeric Ratio | Use Case |
|------|----------|---------------|----------|
| `.square` | `"1:1"` | 1.0 | Social media posts, profile pictures |
| `.standard` | `"4:3"` | 1.333 | Classic TV, presentations |
| `.widescreen` | `"16:9"` | 1.778 | Modern video, YouTube |
| `.ultrawide` | `"21:9"` | 2.333 | Cinematic films, immersive scenes |
| `.portrait` | `"9:16"` | 0.5625 | Mobile video, Instagram stories |
| `.anamorphic` | `"2.39:1"` | 2.39 | Epic cinema, theatrical release |

---

## Appendix A: Complete URL Reference

| Operation | Method | URL Template |
|-----------|--------|-------------|
| Gemini image generation | POST | `https://generativelanguage.googleapis.com/v1beta/models/<MODEL>:generateContent` |
| Veo start operation | POST | `https://generativelanguage.googleapis.com/v1beta/models/<MODEL>:predictLongRunning` |
| Veo poll operation | GET | `https://generativelanguage.googleapis.com/v1beta/<operationName>` |
| Veo download video | GET | `<videoUri>?key=<API_KEY>` |
| Files upload initiate | POST | `https://generativelanguage.googleapis.com/upload/v1beta/files?uploadType=resumable` |
| Files upload content | POST | `<uploadURL from initiate response>` |
| Files get info | GET | `https://generativelanguage.googleapis.com/v1beta/files/<fileId>` |
| Files delete | DELETE | `https://generativelanguage.googleapis.com/v1beta/files/<fileId>` |

## Appendix B: Authentication Summary

| API | Auth Method | Header/Parameter |
|-----|------------|-----------------|
| Gemini (image) | Header | `x-goog-api-key: <KEY>` |
| Veo (start + poll) | Header | `x-goog-api-key: <KEY>` |
| Veo (download) | Query param | `?key=<KEY>` or `&key=<KEY>` |
| Files (all ops) | Header | `x-goog-api-key: <KEY>` |

## Appendix C: Timeout Summary

| Operation | Timeout | Source |
|-----------|---------|--------|
| Gemini image generation | 180s (3 min) | `URLRequest.timeoutInterval` |
| Veo operation polling | 600s (10 min) | Manual timer via `Date()` |
| Veo initial poll delay | 5s | `Task.sleep` |
| Veo poll interval | 3s | `Task.sleep` |
| Files upload | Default URLSession | No custom timeout |
